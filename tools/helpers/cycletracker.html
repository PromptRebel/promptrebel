<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>PromptRebel ‚Äì CycleTracker Mini</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root { --scroll: 0; }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; scroll-behavior: smooth; }
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:#020617;
      color:#e5e7eb;
      line-height:1.6;
      padding-top:64px;
    }
    a { color: inherit; text-decoration: none; }

    body::before{
      content:"";
      position:fixed; inset:0;
      background:
        radial-gradient(circle at 10% 0%, rgba(236,72,153,.35), transparent 55%),
        radial-gradient(circle at 90% 100%, rgba(56,189,248,.35), transparent 55%);
      z-index:-2;
    }
    body::after{
      content:"";
      position:fixed; inset:0;
      opacity:.22;
      pointer-events:none;
      background-image:
        linear-gradient(0deg, rgba(255,255,255,0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
      background-size:3px 3px, 3px 3px;
      mix-blend-mode: soft-light;
      z-index:-1;
    }

    .page{
      max-width:1120px;
      margin:0 auto;
      padding:16px 16px 40px;
    }

    .skip-link{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      top:-40px;
      padding:6px 10px;
      background:#0f172a;
      color:#f9fafb;
      border-radius:999px;
      font-size:13px;
      z-index:60;
    }
    .skip-link:focus-visible{
      top:10px;
      outline:2px solid #22d3ee;
      outline-offset:2px;
    }

    .nav{
      position:fixed; top:0; left:0; right:0;
      z-index:40;
      backdrop-filter: blur(14px);
      background: linear-gradient(to bottom, rgba(15,23,42,.95), rgba(15,23,42,.6));
      border-bottom:1px solid rgba(148,163,184,.1);
    }
    .nav-inner{
      max-width:1120px;
      margin:0 auto;
      padding:10px 16px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      position:relative;
      gap:12px;
    }
    .nav::after{
      content:"";
      position:absolute; left:0; right:0; bottom:0;
      height:2px;
      background: linear-gradient(90deg, #ec4899, rgba(34,211,238,0), #22d3ee);
      transform-origin:left;
      transform: scaleX(var(--scroll));
      transition: transform .1s linear;
      pointer-events:none;
    }

    .brand-link{
      display:inline-flex;
      align-items:center;
      font-size:22px;
      font-weight:800;
      letter-spacing:.05em;
      white-space:nowrap;
      text-shadow: 0 0 8px rgba(236,72,153,.6), 0 0 12px rgba(34,211,238,.4);
      cursor:pointer;
    }
    .brand-link span.accent{
      background: linear-gradient(135deg, #f472b6, #22d3ee);
      -webkit-background-clip:text;
      color:transparent;
    }

    .nav-links{ display:flex; gap:18px; font-size:14px; flex-wrap:wrap; }
    .nav-link{ position:relative; padding-block:4px; }
    .nav-link::after{
      content:"";
      position:absolute; left:0; bottom:-2px;
      width:0; height:2px; border-radius:999px;
      background: linear-gradient(90deg, #f472b6, #22d3ee);
      box-shadow: 0 0 8px rgba(56,189,248,.8);
      transition: width .25s ease;
    }
    .nav-link:hover::after,
    .nav-link:focus-visible::after{ width:100%; }
    .nav-link:focus-visible{ outline:none; }

    .section{ padding:40px 16px 8px; }
    .section:first-of-type{ padding-top:28px; }

    @media(min-width:768px){
      .hero-layout{
        display:grid;
        grid-template-columns: minmax(0, 3fr) minmax(0, 2.2fr);
        gap:32px;
        align-items:start;
      }
    }

    .category-label{
      font-size:12px;
      letter-spacing:.25em;
      text-transform:uppercase;
      color:#f9a8d4;
      margin-bottom:6px;
    }
    .hero-title{
      font-size: clamp(32px, 5vw, 46px);
      font-weight:800;
      margin-bottom:10px;
      text-shadow: 0 0 14px rgba(236,72,153,.6), 0 0 20px rgba(34,211,238,.4);
    }
    .hero-breadcrumbs{
      font-size:12px;
      color:#9ca3af;
      margin-bottom:16px;
    }
    .hero-breadcrumbs a{
      text-decoration: underline;
      text-underline-offset:3px;
    }
    .hero-text-main{
      font-size:15px;
      margin-bottom:10px;
      max-width:46rem;
    }
    .hero-text-sub{
      font-size:14px;
      color:#cbd5f5;
      margin-bottom:18px;
      max-width:52rem;
    }

    .hero-pills{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:10px;
    }

    .hero-pill{
      border-radius:999px;
      padding:10px 14px;
      border:1px solid rgba(248,250,252,.16);
      font-size:13px;
      background: radial-gradient(circle at top left, rgba(30,64,175,.75), rgba(15,23,42,.95));
      box-shadow: 0 12px 30px rgba(15,23,42,.9);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease;
      user-select:none;
    }
    .hero-pill:hover{
      transform: translateY(-2px) scale(1.02);
      border-color: rgba(209,213,219,.28);
      box-shadow: 0 0 18px rgba(34,211,238,.20), 0 12px 30px rgba(2,6,23,.75);
    }
    .hero-pill.primary{
      background: linear-gradient(135deg, #ec4899, #22d3ee);
      color:#020617;
      font-weight:800;
      border:none;
      box-shadow: 0 0 22px rgba(34,211,238,.35), 0 0 22px rgba(236,72,153,.25), 0 12px 30px rgba(2,6,23,.75);
    }

    .cover-wrap{
      border-radius:18px;
      border:1px solid rgba(148,163,184,.18);
      background: radial-gradient(circle at top left, rgba(15,23,42,.9), rgba(15,23,42,.98));
      box-shadow: 0 18px 45px rgba(15,23,42,.95);
      backdrop-filter: blur(18px);
      overflow:hidden;
    }
    .cover{
      width:100%;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      object-position: center;
      display:block;
      filter: saturate(.95) contrast(1.02);
      transform: scale(1.01);
    }
    .cover-caption{
      padding:12px 14px 12px;
      font-size:12px;
      color:#9ca3af;
      border-top:1px solid rgba(148,163,184,.12);
    }

    .section-title{
      font-size:18px;
      font-weight:700;
      margin-bottom:8px;
    }
    .section-subtitle{
      font-size:13px;
      color:#9ca3af;
      margin-bottom:18px;
      max-width:52rem;
    }
    .card{
      border-radius:20px;
      padding:16px 18px;
      border:1px solid rgba(148,163,184,.18);
      background: radial-gradient(circle at top left, rgba(15,23,42,.96), rgba(15,23,42,.99));
      box-shadow: 0 18px 40px rgba(15,23,42,.96);
      backdrop-filter: blur(18px);
      margin-bottom:14px;
    }
    .codebox{
      border-radius:16px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.65);
      padding:14px 14px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      color:#e5e7eb;
      white-space: pre-wrap;
      overflow-x:auto;
    }

    footer{
      margin-top:40px;
      padding-top:16px;
      border-top:1px solid rgba(15,23,42,.9);
      font-size:11px;
      color:#94a3b8;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }
    footer .center-links{ display:flex; gap:10px; }
    footer a{ text-decoration: underline; text-underline-offset:3px; }

    @media(max-width:767px){
      body{ padding-top:60px; }
      .nav-links{ font-size:13px; gap:12px; }
      .section{ padding-top:32px; }
      .hero-layout{ display:block; }
      .cover-wrap{ margin-top:20px; }
    }
    @media(max-width:480px){
      .hero-pills{ flex-direction:column; }
      .hero-pill{ width:100%; }
    }
  </style>
</head>

<body>
  <a href="#main" class="skip-link">Zum Inhalt springen</a>

  <header class="nav">
    <div class="nav-inner">
      <a class="brand-link" href="../../index.html" aria-label="PromptRebel Home">
        Prompt<span class="accent">Rebel</span>
      </a>

      <nav class="nav-links" aria-label="Hauptnavigation">
        <a href="../../index.html#projects" class="nav-link">Projects</a>
        <a href="../../index.html#about" class="nav-link">About</a>
        <a href="../../index.html#lab-notes" class="nav-link">Lab Notes</a>
      </nav>
    </div>
  </header>

  <main class="page" id="main">
    <section class="section">
      <div class="hero-layout">
        <div>
          <div class="category-label">Tools ¬∑ Helpers</div>
          <h1 class="hero-title">CycleTracker Mini</h1>

          <div class="hero-breadcrumbs">
            <span>
              <a href="../../index.html">Home</a> ¬∑
              <a href="../tools.html">Tools</a> ¬∑
              <a href="../helpers.html">Helpers</a> ¬∑
              CycleTracker
            </span>
          </div>

          <p class="hero-text-main">
            Offline Browser-Fahrradcomputer: Speed, Distanz, Zeit &amp; H√∂henmeter ‚Äì ohne Account, ohne Cloud. Speichert Bikes &amp; Fahrten lokal im Browser.
          </p>
          <p class="hero-text-sub">
            Fokus: schnell starten, sauber loggen, sp√§ter problemlos als kleine Website oder PWA hostbar.
          </p>

          <div class="hero-pills">
            <button id="btnOpenHelper" class="hero-pill primary" type="button">üöÄ Open Helper</button>
            <button id="btnCopyCode" class="hero-pill" type="button">üìã Copy Code</button>
          </div>

          <p class="hero-text-sub" style="font-size:12px;color:#9ca3af;margin-top:6px;">
            Hinweis: Standortdaten bleiben im Browser. Funktioniert nur mit erlaubtem Standortzugriff.
          </p>
        </div>

        <aside class="cover-wrap" aria-label="CycleTracker Cover">
          <img class="cover"
               src="/helpers/covers/cycletracker.jpg"
               alt="CycleTracker Mini ‚Äì App Screenshot" />
          <div class="cover-caption">Screenshot der UI (mobile).</div>
        </aside>
      </div>
    </section>

    <section class="section" aria-labelledby="details-title">
      <h2 class="section-title" id="details-title">Was das Ding kann</h2>
      <p class="section-subtitle">Kurz &amp; konkret ‚Äì und dann direkt bauen/benutzen.</p>

      <div class="card">
        <div style="display:grid;gap:8px;font-size:13px;color:#d1d5db;">
          <div>‚úÖ Live: Geschwindigkeit (GPS oder aus Distanz), Distanz, Zeit</div>
          <div>‚úÖ H√∂henmeter: nur positive Anstiege (Altitude-basiert, grob)</div>
          <div>‚úÖ Bikes: mehrere R√§der, Stats pro Bike</div>
          <div>‚úÖ Fahrten speichern: Notiz, Untergrund, Bewertung</div>
          <div>‚úÖ Offline: localStorage, kein Backend</div>
        </div>
      </div>
    </section>

    <section class="section" aria-labelledby="code-title">
      <h2 class="section-title" id="code-title">Code (HTML ‚Äì copy &amp; run)</h2>
      <p class="section-subtitle">Voller Source-Code als Single-File.</p>

      <div class="card">
        <div class="codebox" id="codeBox"></div>
      </div>
    </section>

    <footer>
      <div>¬© PromptRebel | CC BY-NC-SA 4.0</div>
      <div class="center-links">
        <a href="../imprint.html">Imprint</a><span>¬∑</span><a href="../privacy.html">Privacy</a>
      </div>
      <div>build: <span style="color:#22d3ee; text-shadow:0 0 10px rgba(34,211,238,.9);">v0.1.helper.cycletracker</span></div>
    </footer>
  </main>

  <!-- ‚úÖ L√∂sung B FIX: App-Source liegt in script[type=text/plain] (kein </textarea>-Bug) -->
  <script id="helperSource" type="text/plain">
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>CycleTracker Mini 3.4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #18243a 0, #05070c 55%, #020308 100%);
      color: #f8f9fb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 480px;
      padding: 16px 16px 24px;
      border-radius: 24px;
      background: rgba(3, 7, 18, 0.9);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(12px);
    }

    .title {
      text-align: center;
      margin-bottom: 6px;
      font-size: 26px;
      font-weight: 800;
      letter-spacing: .02em;
    }

    .subtitle {
      text-align: center;
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .active-bike {
      text-align: center;
      font-size: 13px;
      color: #cbd5f5;
      margin-bottom: 14px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }

    .card {
      background: radial-gradient(circle at top left, #1f2937 0, #020617 65%);
      border-radius: 18px;
      padding: 14px 14px 12px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.7);
    }

    .card-label {
      font-size: 11px;
      letter-spacing: .18em;
      text-transform: uppercase;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .card-value {
      font-size: 30px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .card-unit {
      font-size: 13px;
      color: #e5e7eb;
    }

    .card-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .controls-main {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .controls-main button {
      flex: 1;
      height: 46px;
      border-radius: 999px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: .02em;
    }

    .btn-start {
      background: linear-gradient(135deg, #34d399, #0ea5e9);
      color: #031016;
    }

    .btn-pause {
      background: #4b5563;
      color: #e5e7eb;
    }

    .btn-save {
      background: #10b981;
      color: #022c22;
      height: 40px;
      border-radius: 999px;
      border: none;
      padding: 0 18px;
      font-size: 14px;
      font-weight: 600;
      margin-right: 8px;
    }

    .btn-reset {
      background: linear-gradient(135deg, #fb7185, #f97316);
      color: #111827;
      height: 40px;
      border-radius: 999px;
      border: none;
      padding: 0 18px;
      font-size: 14px;
      font-weight: 600;
    }

    .controls-secondary {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    button:active {
      transform: translateY(1px) scale(.99);
      box-shadow: 0 0 0 rgba(0, 0, 0, 0);
    }

    .status-text {
      text-align: center;
      font-size: 13px;
      margin-bottom: 10px;
    }

    .status-ok { color: #22c55e; }
    .status-warn { color: #facc15; }
    .status-error { color: #f97373; }

    .footnote {
      font-size: 11px;
      color: #9ca3af;
      text-align: center;
      line-height: 1.4;
      margin-top: 4px;
    }

    .settings-link {
      margin-top: 10px;
      font-size: 13px;
      text-align: center;
      color: #38bdf8;
    }
    .settings-link button {
      background: none;
      border: none;
      color: inherit;
      font: inherit;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .settings-link span.icon {
      font-size: 15px;
    }

    /* Modal Overlay generisch */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      justify-content: center;
      align-items: center;
      padding: 16px;
      z-index: 40;
    }
    .overlay.show { display: flex; }

    .panel {
      background: #020617;
      border-radius: 22px;
      padding: 18px 18px 16px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 22px 50px rgba(0, 0, 0, 0.8);
    }
    .panel h2 {
      font-size: 18px;
      margin-bottom: 8px;
    }
    .panel p {
      font-size: 13px;
      color: #d1d5db;
      margin-bottom: 6px;
    }
    .panel small {
      font-size: 11px;
      color: #9ca3af;
    }
    .panel-section {
      margin-top: 10px;
      margin-bottom: 6px;
      border-top: 1px solid #111827;
      padding-top: 8px;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 3px;
      color: #e5e7eb;
    }
    input[type="text"],
    select,
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #111827;
      background: #020617;
      padding: 8px 9px;
      color: #e5e7eb;
      font-size: 13px;
      margin-bottom: 6px;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }

    .panel-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }
    .btn-small {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      font-weight: 500;
    }
    .btn-ghost {
      background: #111827;
      color: #e5e7eb;
    }
    .btn-primary {
      background: #0ea5e9;
      color: #022c22;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
      margin-top: 4px;
    }
    .stats-box {
      background: #020617;
      border-radius: 12px;
      padding: 6px 8px;
      border: 1px solid #0b1120;
    }
    .stats-label {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    .stats-value {
      font-size: 13px;
      font-weight: 600;
    }

    .rides-list {
      max-height: 140px;
      overflow-y: auto;
      margin-top: 4px;
      border-radius: 10px;
      border: 1px solid #0b1120;
      padding: 6px 8px;
      background: #020617;
      font-size: 12px;
    }
    .ride-item {
      padding: 2px 0;
      border-bottom: 1px solid #020617;
    }
    .ride-item:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="title">CycleTracker Mini 3.4</div>
  <div class="subtitle">Browser-Fahrradcomputer ‚Äì komplett offline im Browser</div>
  <div id="activeBikeLabel" class="active-bike">Aktives Fahrrad: ‚Äì</div>

  <div class="grid">
    <div class="card">
      <div class="card-label">Geschwindigkeit</div>
      <div id="speedValue" class="card-value">0.0</div>
      <div class="card-unit">km/h</div>
      <div class="card-sub" id="speedSourceLabel">‚Äì</div>
    </div>
    <div class="card">
      <div class="card-label">Distanz</div>
      <div id="distValue" class="card-value">0.00</div>
      <div class="card-unit">km</div>
      <div class="card-sub" id="distSub">aktuelle Fahrt</div>
    </div>
    <div class="card">
      <div class="card-label">H√∂henmeter ‚Üë</div>
      <div id="ascentValue" class="card-value">0</div>
      <div class="card-unit">nur positive Anstiege</div>
    </div>
    <div class="card">
      <div class="card-label">Zeit</div>
      <div id="timeValue" class="card-value">00:00</div>
      <div class="card-unit">Laufzeit dieser Fahrt</div>
    </div>
  </div>

  <div class="controls-main">
    <button id="btnStart" class="btn-start">Start</button>
    <button id="btnPause" class="btn-pause" disabled>Pause</button>
  </div>

  <div class="controls-secondary">
    <button id="btnSaveRide" class="btn-save" disabled>Fahrt speichern</button>
    <button id="btnReset" class="btn-reset">Reset</button>
  </div>

  <div id="statusText" class="status-text status-warn">
    Bereit. Standortzugriff muss erlaubt sein.
  </div>

  <div class="footnote">
    Hinweis: Funktioniert nur, wenn dein Browser Standortzugriff erlaubt.<br/>
    F√ºr einen echten Fahrradcomputer sp√§ter am besten als kleine Website oder PWA hosten.
  </div>

  <div class="settings-link">
    <button id="btnOpenSettings">
      <span class="icon">‚öôÔ∏è</span>
      <span>Einstellungen / Bikes &amp; Statistik</span>
    </button>
  </div>
</div>

<div id="settingsOverlay" class="overlay">
  <div class="panel">
    <h2>Fahrr√§der &amp; Einstellungen</h2>
    <p>Verwalte deine Bikes, Statistik und Auto-Pause.</p>

    <div class="panel-section">
      <label for="bikeSelect">Aktives Fahrrad ausw√§hlen</label>
      <select id="bikeSelect"></select>
      <small>Beim Wechsel darf keine Fahrt laufen.</small>
    </div>

    <div class="panel-section">
      <p style="margin-bottom:4px;"><strong>Bike anlegen / bearbeiten</strong></p>
      <label for="bikeName">Name</label>
      <input type="text" id="bikeName" placeholder="z. B. Alltagsrad" />
      <label for="bikeBrand">Hersteller (optional)</label>
      <input type="text" id="bikeBrand" placeholder="z. B. Cube, Canyon‚Ä¶" />
      <label for="bikeType">Typ / Art (frei)</label>
      <input type="text" id="bikeType" placeholder="z. B. Citybike, MTB, Gravel‚Ä¶" />
      <div class="panel-buttons" style="margin-top:4px; justify-content:flex-start;">
        <button id="btnSaveBikeMeta" class="btn-small btn-primary">Bike speichern</button>
      </div>
      <small>Die Daten werden lokal im Browser (localStorage) gespeichert.</small>
    </div>

    <div class="panel-section">
      <p style="margin-bottom:4px;"><strong>Statistik (aktuelles Bike)</strong></p>
      <div class="stats-grid">
        <div class="stats-box">
          <div class="stats-label">Gesamt-Distanz</div>
          <div id="statTotalDist" class="stats-value">0.00 km</div>
        </div>
        <div class="stats-box">
          <div class="stats-label">Gesamt-Zeit</div>
          <div id="statTotalTime" class="stats-value">00:00 h</div>
        </div>
        <div class="stats-box">
          <div class="stats-label">Gesamt-H√∂henmeter</div>
          <div id="statTotalAscent" class="stats-value">0 m</div>
        </div>
        <div class="stats-box">
          <div class="stats-label">Anzahl Fahrten</div>
          <div id="statRideCount" class="stats-value">0</div>
        </div>
        <div class="stats-box">
          <div class="stats-label">L√§ngste Fahrt</div>
          <div id="statLongestRide" class="stats-value">0.00 km</div>
        </div>
        <div class="stats-box">
          <div class="stats-label">Beste √ò-Geschwindigkeit</div>
          <div id="statBestAvg" class="stats-value">0.0 km/h</div>
        </div>
      </div>

      <div style="margin-top:8px;font-size:12px;color:#9ca3af;">Letzte Fahrten</div>
      <div id="ridesList" class="rides-list">
        <div style="color:#6b7280;">Noch keine Fahrten gespeichert.</div>
      </div>
    </div>

    <div class="panel-section">
      <p style="margin-bottom:4px;"><strong>Verhalten</strong></p>
      <label style="display:flex;align-items:center;gap:6px;font-size:12px;">
        <input type="checkbox" id="chkAutoPause" style="width:auto;"/>
        Auto-Pause, wenn App in den Hintergrund geht (empfohlen)
      </label>
    </div>

    <div class="panel-buttons">
      <button id="btnCloseSettings" class="btn-small btn-ghost">Schlie√üen</button>
    </div>
  </div>
</div>

<div id="saveOverlay" class="overlay">
  <div class="panel">
    <h2>Fahrt speichern</h2>
    <p>Optional kannst du dieser Fahrt eine Notiz geben.</p>

    <label for="noteText">Notiz / Stimmung</label>
    <textarea id="noteText"
      placeholder="z. B. Feierabendrunde, leicht windig, hat Spa√ü gemacht."></textarea>

    <label for="surfaceText">Untergrund</label>
    <input id="surfaceText" type="text"
      placeholder="z. B. Asphalt, Schotter, Waldweg" />

    <label for="ratingSelect">Bewertung</label>
    <select id="ratingSelect">
      <option value="">Keine Bewertung</option>
      <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ ‚Äì z√§h</option>
      <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ ‚Äì ok</option>
      <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ ‚Äì solide</option>
      <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ ‚Äì gut</option>
      <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ‚Äì mega!</option>
    </select>

    <div class="panel-buttons">
      <button id="btnSaveWithoutNote" class="btn-small btn-ghost">Ohne Notiz speichern</button>
      <button id="btnSaveWithNote" class="btn-small btn-primary">Speichern</button>
    </div>
  </div>
</div>

<script>
(function () {
  "use strict";

  // ----- DOM -----
  const speedValueEl = document.getElementById("speedValue");
  const speedSourceLabelEl = document.getElementById("speedSourceLabel");
  const distValueEl = document.getElementById("distValue");
  const ascentValueEl = document.getElementById("ascentValue");
  const timeValueEl = document.getElementById("timeValue");
  const statusTextEl = document.getElementById("statusText");
  const activeBikeLabelEl = document.getElementById("activeBikeLabel");

  const btnStart = document.getElementById("btnStart");
  const btnPause = document.getElementById("btnPause");
  const btnReset = document.getElementById("btnReset");
  const btnSaveRide = document.getElementById("btnSaveRide");

  const settingsOverlay = document.getElementById("settingsOverlay");
  const btnOpenSettings = document.getElementById("btnOpenSettings");
  const btnCloseSettings = document.getElementById("btnCloseSettings");
  const bikeSelectEl = document.getElementById("bikeSelect");
  const bikeNameEl = document.getElementById("bikeName");
  const bikeBrandEl = document.getElementById("bikeBrand");
  const bikeTypeEl = document.getElementById("bikeType");
  const btnSaveBikeMeta = document.getElementById("btnSaveBikeMeta");
  const chkAutoPause = document.getElementById("chkAutoPause");

  const statTotalDistEl = document.getElementById("statTotalDist");
  const statTotalTimeEl = document.getElementById("statTotalTime");
  const statTotalAscentEl = document.getElementById("statTotalAscent");
  const statRideCountEl = document.getElementById("statRideCount");
  const statLongestRideEl = document.getElementById("statLongestRide");
  const statBestAvgEl = document.getElementById("statBestAvg");
  const ridesListEl = document.getElementById("ridesList");

  const saveOverlay = document.getElementById("saveOverlay");
  const noteTextEl = document.getElementById("noteText");
  const surfaceTextEl = document.getElementById("surfaceText");
  const ratingSelectEl = document.getElementById("ratingSelect");
  const btnSaveWithoutNote = document.getElementById("btnSaveWithoutNote");
  const btnSaveWithNote = document.getElementById("btnSaveWithNote");

  // ----- State -----
  const STORAGE_KEY = "cycleTrackerMini3_bikes_v1";
  const SETTINGS_KEY = "cycleTrackerMini3_settings_v1";

  let bikes = [];
  let activeBikeId = null;

  let watchId = null;
  let tracking = false;
  let autoPauseEnabled = true;

  let timerId = null;
  let lastUpdateTime = null;
  let lastPosition = null;

  let currentRide = null; // {distanceM, ascentM, timeS, points:[]}
  let ridePendingForSave = null; // wird in Dialog √ºbernommen

  // ----- Helpers -----
  function formatKm(meters) {
    return (meters / 1000).toFixed(2);
  }
  function formatTime(seconds) {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
  }
  function formatTimeHours(seconds) {
    const h = seconds / 3600;
    return h.toFixed(2);
  }
  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = Math.PI / 180;
    const dLat = (lat2 - lat1) * toRad;
    const dLon = (lon2 - lon1) * toRad;
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1 * toRad) *
        Math.cos(lat2 * toRad) *
        Math.sin(dLon / 2) *
        Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function setStatus(text, type) {
    statusTextEl.textContent = text;
    statusTextEl.classList.remove("status-ok", "status-warn", "status-error");
    if (type === "ok") statusTextEl.classList.add("status-ok");
    else if (type === "error") statusTextEl.classList.add("status-error");
    else statusTextEl.classList.add("status-warn");
  }

  // ----- Storage -----
  function loadSettings() {
    try {
      const raw = localStorage.getItem(SETTINGS_KEY);
      if (!raw) return;
      const s = JSON.parse(raw);
      if (typeof s.autoPauseEnabled === "boolean") {
        autoPauseEnabled = s.autoPauseEnabled;
      }
    } catch (e) { /* ignore */ }
    chkAutoPause.checked = autoPauseEnabled;
  }
  function saveSettings() {
    const s = { autoPauseEnabled };
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
  }

  function loadBikes() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) throw new Error("no data");
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed.bikes)) throw new Error("invalid");
      bikes = parsed.bikes;
      activeBikeId = parsed.activeBikeId || (bikes[0] && bikes[0].id) || null;
    } catch (e) {
      bikes = [];
      activeBikeId = null;
    }
    if (!bikes.length) {
      const id = "bike-" + Date.now();
      bikes.push({
        id,
        name: "Mein erstes Fahrrad",
        brand: "",
        type: "",
        stats: {
          totalDistanceM: 0,
          totalAscentM: 0,
          totalTimeS: 0,
          rideCount: 0,
          longestRideM: 0,
          bestAvgSpeedKmh: 0
        },
        rides: []
      });
      activeBikeId = id;
      saveBikes();
    }
  }

  function saveBikes() {
    const payload = { bikes, activeBikeId };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  }

  function getActiveBike() {
    return bikes.find(b => b.id === activeBikeId) || null;
  }

  // ----- UI: Bikes & Statistik -----
  function refreshBikeSelect() {
    bikeSelectEl.innerHTML = "";
    bikes.forEach(b => {
      const opt = document.createElement("option");
      opt.value = b.id;
      opt.textContent = b.name || "(unbenannt)";
      bikeSelectEl.appendChild(opt);
    });
    bikeSelectEl.value = activeBikeId;
    const active = getActiveBike();
    activeBikeLabelEl.textContent =
      "Aktives Fahrrad: " + (active ? (active.name || "(unbenannt)") : "‚Äì");
    if (active) {
      bikeNameEl.value = active.name || "";
      bikeBrandEl.value = active.brand || "";
      bikeTypeEl.value = active.type || "";
    }
    refreshStatsUI();
  }

  function refreshStatsUI() {
    const bike = getActiveBike();
    if (!bike) return;
    const s = bike.stats;
    statTotalDistEl.textContent = formatKm(s.totalDistanceM) + " km";
    statTotalTimeEl.textContent = formatTimeHours(s.totalTimeS) + " h";
    statTotalAscentEl.textContent = s.totalAscentM.toFixed(0) + " m";
    statRideCountEl.textContent = String(s.rideCount);
    statLongestRideEl.textContent = formatKm(s.longestRideM) + " km";
    statBestAvgEl.textContent = s.bestAvgSpeedKmh.toFixed(1) + " km/h";

    ridesListEl.innerHTML = "";
    if (!bike.rides.length) {
      const div = document.createElement("div");
      div.style.color = "#6b7280";
      div.textContent = "Noch keine Fahrten gespeichert.";
      ridesListEl.appendChild(div);
      return;
    }
    const last = bike.rides.slice(-10).reverse();
    last.forEach(r => {
      const div = document.createElement("div");
      div.className = "ride-item";
      const date = new Date(r.dateIso).toLocaleString();
      const distKm = formatKm(r.distanceM);
      const timeStr = formatTime(r.timeS);
      const avg = (r.distanceM / 1000) / (r.timeS / 3600 || 1);
      div.textContent =
        date + " ‚Äì " + distKm + " km, " + timeStr + ", √ò " +
        avg.toFixed(1) + " km/h";
      ridesListEl.appendChild(div);
    });
  }

  // ----- Tracking -----
  function resetCurrentRide() {
    currentRide = {
      distanceM: 0,
      ascentM: 0,
      timeS: 0,
      lastAltitude: null
    };
    lastPosition = null;
    lastUpdateTime = null;
    speedValueEl.textContent = "0.0";
    distValueEl.textContent = "0.00";
    ascentValueEl.textContent = "0";
    timeValueEl.textContent = "00:00";
    speedSourceLabelEl.textContent = "‚Äì";
    btnSaveRide.disabled = true;
  }

  function startTimer() {
    if (timerId) return;
    timerId = setInterval(() => {
      if (!tracking || !currentRide) return;
      currentRide.timeS += 1;
      timeValueEl.textContent = formatTime(currentRide.timeS);
    }, 1000);
  }

  function stopTimer() {
    if (timerId) {
      clearInterval(timerId);
      timerId = null;
    }
  }

  function onGeoSuccess(pos) {
    const coords = pos.coords;
    const now = Date.now();

    // Geschwindigkeit
    let speedKmh = 0;
    let source = "";
    if (typeof coords.speed === "number" && !isNaN(coords.speed)) {
      speedKmh = coords.speed * 3.6;
      source = "GPS-Speed";
    }

    if (lastPosition) {
      const dt = (now - lastUpdateTime) / 1000;
      const d = haversine(
        lastPosition.latitude,
        lastPosition.longitude,
        coords.latitude,
        coords.longitude
      );
      if (dt > 0) {
        const v = d / dt;
        const vKmh = v * 3.6;
        if (!speedKmh || vKmh < speedKmh - 3) {
          speedKmh = vKmh;
          source = "aus Distanz";
        }
      }

      // Spr√ºnge filtern
      if (speedKmh > 60) {
        // unrealistischer Sprung, ignorieren
      } else if (currentRide && tracking) {
        currentRide.distanceM += d;
        distValueEl.textContent = formatKm(currentRide.distanceM);
      }
    }

    // H√∂henmeter
    if (currentRide && typeof coords.altitude === "number") {
      const alt = coords.altitude;
      if (currentRide.lastAltitude == null) {
        currentRide.lastAltitude = alt;
      } else {
        const diff = alt - currentRide.lastAltitude;
        if (diff > 1.5) {
          currentRide.distanceM && (currentRide.ascentM = currentRide.ascentM || 0);
          currentRide.ascentM += diff;
          ascentValueEl.textContent = Math.round(
            currentRide.ascentM || 0
          ).toString();
        }
        currentRide.lastAltitude = alt;
      }
    }

    if (speedKmh < 0.5) speedKmh = 0;
    speedValueEl.textContent = speedKmh.toFixed(1);
    speedSourceLabelEl.textContent = source || "‚Äì";

    lastPosition = coords;
    lastUpdateTime = now;
  }

  function onGeoError(err) {
    console.warn("Geo error", err);
    if (err.code === 1) {
      setStatus(
        "Standortzugriff verweigert. Bitte im Browser erlauben.",
        "error"
      );
    } else {
      setStatus("Standort nicht verf√ºgbar.", "error");
    }
  }

  function startTracking() {
    if (!navigator.geolocation) {
      setStatus("Geolocation wird nicht unterst√ºtzt.", "error");
      return;
    }
    if (!currentRide) resetCurrentRide();

    tracking = true;
    btnStart.disabled = true;
    btnPause.disabled = false;
    btnSaveRide.disabled = true;
    setStatus("L√§uft. Gute Fahrt!", "ok");

    if (watchId != null) {
      navigator.geolocation.clearWatch(watchId);
    }
    lastPosition = null;
    lastUpdateTime = null;

    watchId = navigator.geolocation.watchPosition(onGeoSuccess, onGeoError, {
      enableHighAccuracy: true,
      maximumAge: 1000,
      timeout: 10000
    });

    startTimer();
  }

  function pauseTracking(auto = false) {
    tracking = false;
    btnStart.disabled = false;
    btnPause.disabled = true;
    if (auto) {
      setStatus(
        "Automatisch pausiert (App im Hintergrund). Zum Fortsetzen ‚ÄûStart‚Äú dr√ºcken.",
        "warn"
      );
    } else {
      setStatus("Pausiert. Zum Fortsetzen ‚ÄûStart‚Äú dr√ºcken.", "warn");
    }
    // Fahrt ist noch aktiv -> Speichern m√∂glich
    if (currentRide && currentRide.distanceM > 0) {
      btnSaveRide.disabled = false;
    }
  }

  function hardReset() {
    if (tracking && !confirm("Es l√§uft noch eine Fahrt. Wirklich alles zur√ºcksetzen?")) {
      return;
    }
    tracking = false;
    if (watchId != null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    stopTimer();
    resetCurrentRide();
    btnStart.disabled = false;
    btnPause.disabled = true;
    btnSaveRide.disabled = true;
    setStatus("Bereit. Standortzugriff muss erlaubt sein.", "warn");
  }

  // ----- Fahrt speichern / Notiz -----
  function openSaveDialog() {
    if (!currentRide || currentRide.distanceM <= 0) {
      alert("Es gibt keine Fahrtdaten zum Speichern. Bitte zuerst fahren.");
      return;
    }
    // Kopie in pending-Objekt
    ridePendingForSave = {
      distanceM: currentRide.distanceM,
      ascentM: currentRide.ascentM || 0,
      timeS: currentRide.timeS
    };
    noteTextEl.value = "";
    surfaceTextEl.value = "";
    ratingSelectEl.value = "";
    saveOverlay.classList.add("show");
  }

  function closeSaveDialog() {
    saveOverlay.classList.remove("show");
  }

  function persistRide(extra) {
    const bike = getActiveBike();
    if (!bike || !ridePendingForSave) return;
    const r = {
      id: "ride-" + Date.now(),
      dateIso: new Date().toISOString(),
      distanceM: ridePendingForSave.distanceM,
      ascentM: ridePendingForSave.ascentM,
      timeS: ridePendingForSave.timeS,
      note: extra.note || "",
      surface: extra.surface || "",
      rating: extra.rating || ""
    };
    bike.rides.push(r);

    const stats = bike.stats;
    stats.totalDistanceM += r.distanceM;
    stats.totalAscentM += r.ascentM;
    stats.totalTimeS += r.timeS;
    stats.rideCount += 1;
    if (r.distanceM > stats.longestRideM) stats.longestRideM = r.distanceM;
    const avgKmh = (r.distanceM / 1000) / (r.timeS / 3600 || 1);
    if (avgKmh > stats.bestAvgSpeedKmh) stats.bestAvgSpeedKmh = avgKmh;

    saveBikes();
    refreshStatsUI();

    ridePendingForSave = null;
    currentRide = null;
    btnSaveRide.disabled = true;
    setStatus("Fahrt gespeichert.", "ok");
  }

  // ----- Events -----
  btnStart.addEventListener("click", () => {
    startTracking();
  });

  btnPause.addEventListener("click", () => {
    pauseTracking(false);
  });

  btnReset.addEventListener("click", () => {
    hardReset();
  });

  btnSaveRide.addEventListener("click", () => {
    // Speichern nur, wenn gerade NICHT getrackt wird
    if (tracking) {
      pauseTracking(false);
    }
    openSaveDialog();
  });

  btnOpenSettings.addEventListener("click", () => {
    settingsOverlay.classList.add("show");
    refreshStatsUI();
  });

  btnCloseSettings.addEventListener("click", () => {
    settingsOverlay.classList.remove("show");
  });

  chkAutoPause.addEventListener("change", () => {
    autoPauseEnabled = chkAutoPause.checked;
    saveSettings();
  });

  bikeSelectEl.addEventListener("change", () => {
    const newId = bikeSelectEl.value;
    if (tracking) {
      alert("Bitte zuerst die aktuelle Fahrt stoppen/pausieren.");
      bikeSelectEl.value = activeBikeId;
      return;
    }
    activeBikeId = newId;
    saveBikes();
    refreshBikeSelect();
  });

  btnSaveBikeMeta.addEventListener("click", () => {
    const bike = getActiveBike();
    if (!bike) return;
    bike.name = bikeNameEl.value.trim() || "Unbenanntes Bike";
    bike.brand = bikeBrandEl.value.trim();
    bike.type = bikeTypeEl.value.trim();
    saveBikes();
    refreshBikeSelect();
    setStatus("Bike-Daten gespeichert.", "ok");
  });

  // Save dialog buttons
  btnSaveWithoutNote.addEventListener("click", () => {
    if (!ridePendingForSave) {
      closeSaveDialog();
      return;
    }
    persistRide({ note: "", surface: "", rating: "" });
    closeSaveDialog();
    hardReset();
  });

  btnSaveWithNote.addEventListener("click", () => {
    if (!ridePendingForSave) {
      closeSaveDialog();
      return;
    }
    const note = noteTextEl.value.trim();
    const surface = surfaceTextEl.value.trim();
    const rating = ratingSelectEl.value;
    persistRide({ note, surface, rating });
    closeSaveDialog();
    hardReset();
  });

  // Klick auf Overlay schlie√üt NICHT, damit man nichts versehentlich verliert

  // Auto-Pause bei Hintergrund
  document.addEventListener("visibilitychange", () => {
    if (document.hidden && tracking && autoPauseEnabled) {
      pauseTracking(true);
    }
  });

  // ----- Init -----
  function init() {
    loadSettings();
    loadBikes();
    refreshBikeSelect();
    resetCurrentRide();
    setStatus("Bereit. Standortzugriff muss erlaubt sein.", "warn");
  }

  init();
})();
</script>
</body>
</html>

  </script>

  <script>
    window.addEventListener("scroll", () => {
      const doc = document.documentElement;
      const scrollable = doc.scrollHeight - window.innerHeight;
      const ratio = scrollable > 0 ? window.scrollY / scrollable : 0;
      document.documentElement.style.setProperty("--scroll", ratio.toString());
    });

    const HELPER_URL = "./cycletrackerfile.html"; // Pfad zur laufenden App-Datei
    const HELPER_SOURCE_CODE = document.getElementById("helperSource").textContent.trim();

    document.getElementById("codeBox").textContent = HELPER_SOURCE_CODE;

    async function copyToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        const temp = document.createElement("textarea");
        temp.value = text;
        temp.setAttribute("readonly", "");
        temp.style.position = "fixed";
        temp.style.left = "-9999px";
        document.body.appendChild(temp);
        temp.select();
        document.execCommand("copy");
        document.body.removeChild(temp);
      }
    }

    function flashButton(btn, okText = "‚úÖ Kopiert!") {
      const original = btn.innerHTML;
      btn.innerHTML = okText;
      btn.disabled = true;
      setTimeout(() => {
        btn.innerHTML = original;
        btn.disabled = false;
      }, 2000);
    }

    document.getElementById("btnOpenHelper").addEventListener("click", () => {
      window.open(HELPER_URL, "_blank", "noopener,noreferrer");
    });

    document.getElementById("btnCopyCode").addEventListener("click", async () => {
      try {
        await copyToClipboard(HELPER_SOURCE_CODE);
        flashButton(document.getElementById("btnCopyCode"));
      } catch (e) {
        console.error(e);
        flashButton(document.getElementById("btnCopyCode"), "‚ö†Ô∏è Copy failed");
      }
    });
  </script>
</body>
</html>
